<template>
	<view
		class="video-container"
		@touchstart="handleTouchStart"
		@touchmove="handleTouchMove"
		@touchend="handleTouchEnd"
	>
		<!-- #ifdef APP-PLUS -->
		<zego-remote-view v-if="sid" :streamID="sid" style="flex: 1;"></zego-remote-view>
		<!-- #endif -->
		
		<view class="voice" @click="voice">
		<image style="width: 16rpx;height: 16rpx; " :src="'/static/images/video/voice-'+(voiceDisable?'close':'open')+'.png'" mode="widthFix" ></image>
		</view>

		<!-- å…³é—­æŒ‰é’® - ä»…åœ¨è¶…è¿‡é»˜è®¤å¤§å°æ—¶æ˜¾ç¤º -->
		<view v-if="isOverDefaultSize" class="close-button" @click="resetToDefault">
			<text class="close-text">å…³é—­</text>
		</view>

		<!-- å››è§’ç¼©æ”¾æ§åˆ¶ç‚¹ - ç›´æ¥å®šä½ï¼Œä¸ç»¿è‰²æµ‹è¯•ç‚¹ä½¿ç”¨ç›¸åŒåæ ‡ç³» -->
		<!-- å·¦ä¸Šè§’ -->
		<view class="scale-corner scale-corner-tl" :class="{ 'transparent': !showInteraction }"
			@touchstart="handleScaleStart"
			@touchmove="handleScaleMove"
			@touchend="handleScaleEnd">
			<view class="corner-line corner-line-h"></view>
			<view class="corner-line corner-line-v"></view>
		</view>

		<!-- å³ä¸Šè§’ -->
		<view class="scale-corner scale-corner-tr" :class="{ 'transparent': !showInteraction }"
			@touchstart="handleScaleStart"
			@touchmove="handleScaleMove"
			@touchend="handleScaleEnd">
			<view class="corner-line corner-line-h"></view>
			<view class="corner-line corner-line-v"></view>
		</view>

		<!-- å·¦ä¸‹è§’ -->
		<view class="scale-corner scale-corner-bl" :class="{ 'transparent': !showInteraction }"
			@touchstart="handleScaleStart"
			@touchmove="handleScaleMove"
			@touchend="handleScaleEnd">
			<view class="corner-line corner-line-h"></view>
			<view class="corner-line corner-line-v"></view>
		</view>

		<!-- å³ä¸‹è§’ -->
		<view class="scale-corner scale-corner-br" :class="{ 'transparent': !showInteraction }"
			@touchstart="handleScaleStart"
			@touchmove="handleScaleMove"
			@touchend="handleScaleEnd">
			<view class="corner-line corner-line-h"></view>
			<view class="corner-line corner-line-v"></view>
		</view>
	</view>
</template>

<script setup>
	import {
		ref,
		reactive,
		onMounted,
		onUnmounted
	} from "vue"
	import {
		onUnload
	} from '@dcloudio/uni-app';
	import ZegoExpressEngine, {
		ZegoOrientation,
		ZegoUpdateType
	} from '@/uni_modules/zego-ZegoExpressUniApp-JS/components/zego-ZegoExpressUniApp-JS/lib/ZegoExpressEngine';
	import {
		useZego
	} from "@/composables/useZego";
	import {
		usePublish
	} from "@/composables/usePublish";
	import {
		usePlay
	} from "@/composables/usePlay";
	import keyCenter from "@/composables/KeyCenter.js";
	import ZegoRemoteView from "@/uni_modules/zego-ZegoExpressUniApp-JS/components/zego-ZegoExpressUniApp-JS/zego-view/ZegoRemoteView";
	const {
		info,
		logHeight,
		userID,
		userName,
		isLogin,
		isRequest,
		engine,
		// æ–¹æ³•
		createEngine,
		loginRoom,
		logoutRoom,
		changeLogViewSize,
		appendActionInfo,
		appendSuccessInfo,
		appendFailureInfo,
		appendCallbackInfo
	} = useZego()
	const {
		publishStreamID,
		publishBtnName,
		isPublishingStream,
		localVideoElem,
		pubVideoMuted,
		startPublishingStream,
		stopPublishingStream,
		startPreview,
		stopPreview,
		onClickPublish,
		addPublishListeners,
	} = usePublish({
		engine,
		appendActionInfo,
		appendCallbackInfo,
		appendSuccessInfo
	})
	const {
		playStreamID,
		playVideoElem,
		isPlayingStream,
		playBtnName,
		playVideoMuted,
		playStream,
		onClickPlay,
		startPlayingStream,
		stopPlayingStream,
		addPlayListeners,
		playError
	} = usePlay({
		engine,
		appendActionInfo,
		appendCallbackInfo,
		appendSuccessInfo
	})
	const userInfo = uni.getStorageSync('userInfo');
	const sid = uni.getStorageSync('remoteUserId');

	// é¡µé¢çŠ¶æ€ç®¡ç†
	const isPageActive = ref(true);
	const initializationInProgress = ref(false);
	const isPlayingActive = ref(false); // æ’­æ”¾çŠ¶æ€è¿½è¸ª

	// æ‹–æ‹½ç›¸å…³çŠ¶æ€ - é»˜è®¤å¼€å¯
	const dragMode = ref(true)
	const dragData = ref(null)
	const voiceDisable = ref(false)

	// ç¼©æ”¾ç›¸å…³çŠ¶æ€ - é»˜è®¤å¼€å¯
	const scaleMode = ref(true)
	const scaleData = ref(null)
	const initialDistance = ref(0)
	const cornerScaleData = ref(null)

	// äº¤äº’æ˜¾ç¤ºçŠ¶æ€
	const showInteraction = ref(true)
	const interactionTimer = ref(null)

	// é»˜è®¤å¤§å°çŠ¶æ€
	const isOverDefaultSize = ref(false)
	const defaultSize = { width: 146, height: 64 } // rpxå•ä½

	// çª—å£ä½ç½®ä¿¡æ¯ï¼ˆç”¨äºä¿®å¤ç¼©æ”¾æ–¹å‘é—®é¢˜ï¼‰
	const windowPosition = ref({
		left: 0,
		top: 0,
		width: 146,
		height: 64,
		screenWidth: 375,
		screenHeight: 667
	})
	onMounted(async () => {
		// æ£€æŸ¥æ˜¯å¦ä¸ºçº¿ä¸Šå¯¹æˆ˜æ¨¡å¼
		const gameSettings = uni.getStorageSync('currentGameSettings');
		console.log('ğŸ¬ [remoteVideo] æ¸¸æˆè®¾ç½®æ£€æŸ¥:', gameSettings);
		if (!gameSettings || gameSettings.type !== 11) {
			console.log('ğŸ¬ [remoteVideo] éçº¿ä¸Šå¯¹æˆ˜æ¨¡å¼ï¼Œè·³è¿‡è¿œç¨‹è§†é¢‘åˆå§‹åŒ–ã€‚å½“å‰æ¨¡å¼:', gameSettings?.type);
			return;
		}
		console.log('ğŸ¬ [remoteVideo] ç¡®è®¤ä¸ºçº¿ä¸Šå¯¹æˆ˜æ¨¡å¼ï¼Œç»§ç»­è¿œç¨‹è§†é¢‘åˆå§‹åŒ–');

	// æ™ºèƒ½é‡è¯•æœºåˆ¶
	const maxRetryAttempts = 3;
	const retryDelay = 1000; // 1ç§’
	let currentRetryAttempt = 0;
	
	const retryInitialization = () => {
		if (currentRetryAttempt >= maxRetryAttempts) {
			console.error('ğŸ¬ [remoteVideo] å·²è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°ï¼Œåˆå§‹åŒ–å¤±è´¥');
			uni.showToast({
				title: 'è¿œç¨‹è§†é¢‘åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·é‡æ–°è¿›å…¥æ¸¸æˆ',
				icon: 'none',
				duration: 3000
			});
			return false;
		}
		
		currentRetryAttempt++;
		console.log(`ğŸ¬ [remoteVideo] å¼€å§‹ç¬¬${currentRetryAttempt}æ¬¡é‡è¯•...`);
		
		// é‡è¯•å‰å°è¯•ä¿®å¤Token
		const app = getApp();
		if (app && typeof app.checkTokenIntegrityOnResume === 'function') {
			app.checkTokenIntegrityOnResume();
		}
		if (app && typeof app.restoreRemoteVideoData === 'function') {
			app.restoreRemoteVideoData();
		}
		
		setTimeout(() => {
			performDataCheck();
		}, retryDelay * currentRetryAttempt); // é€’å¢å»¶è¿Ÿ
		
		return true;
	};
	
	const performDataCheck = () => {
		// ä½¿ç”¨å…¨å±€æ•°æ®æ£€æŸ¥åŠŸèƒ½
		uni.$emit('check-remote-video-data', (result) => {
			console.log(`ğŸ¬ [remoteVideo] ç¬¬${currentRetryAttempt || 1}æ¬¡æ•°æ®æ£€æŸ¥ç»“æœ:`, result);
			
			if (!result.isComplete) {
				let missingItems = [];
				if (result.missingData.roomId) missingItems.push('æˆ¿é—´ID');
				if (result.missingData.remoteUserId) missingItems.push('è¿œç¨‹ç”¨æˆ·ID');
				if (result.missingData.zeGoTokenThird) missingItems.push('Zego Token');
				
				console.error('ğŸ¬ [remoteVideo] âŒ æ•°æ®ä¸å®Œæ•´ï¼Œç¼ºå°‘:', missingItems.join('ã€'));
				
				// å°è¯•é‡è¯•
				if (!retryInitialization()) {
					uni.showToast({
						title: `è¿œç¨‹è§†é¢‘åˆå§‹åŒ–æ•°æ®ä¸å®Œæ•´ï¼Œç¼ºå°‘ï¼š${missingItems.join('ã€')}`,
						icon: 'none',
						duration: 5000
					});
				}
				return;
			}
			
			console.log('ğŸ¬ [remoteVideo] âœ… æ•°æ®æ£€æŸ¥é€šè¿‡ï¼Œå¼€å§‹åˆå§‹åŒ–');
			currentRetryAttempt = 0; // é‡ç½®é‡è¯•è®¡æ•°
			isPageActive.value = true;
			init();
		});
	};

		// ä½¿ç”¨å…¨å±€æ•°æ®æ£€æŸ¥åŠŸèƒ½
		performDataCheck();
	})

	const init = async () => {
		// é˜²æ­¢é‡å¤åˆå§‹åŒ–
		if (initializationInProgress.value) {
			console.log('ğŸ¬ [remoteVideo] åˆå§‹åŒ–æ­£åœ¨è¿›è¡Œä¸­ï¼Œè·³è¿‡é‡å¤è°ƒç”¨');
			return;
		}

		// æ£€æŸ¥é¡µé¢æ˜¯å¦ä»ç„¶æ´»è·ƒ
		if (!isPageActive.value) {
			console.log('ğŸ¬ [remoteVideo] é¡µé¢å·²ä¸æ´»è·ƒï¼Œå–æ¶ˆåˆå§‹åŒ–');
			return;
		}

		initializationInProgress.value = true;

		try {
			console.log('ğŸ¬ [remoteVideo] ===== å¼€å§‹è¿œç¨‹è§†é¢‘åˆå§‹åŒ– =====');
			const roomId = uni.getStorageSync('roomID');
			let zeGoTokenThird = uni.getStorageSync('zeGoTokenThird');
			
			// å¦‚æœzeGoTokenThirdä¸å­˜åœ¨ï¼Œå°è¯•ä»zeGoTokenè·å–
			if (!zeGoTokenThird) {
				const zeGoToken = uni.getStorageSync('zeGoToken');
				if (zeGoToken) {
					zeGoTokenThird = zeGoToken;
					uni.setStorageSync('zeGoTokenThird', zeGoTokenThird);
					console.log('ğŸ¬ [remoteVideo] è‡ªåŠ¨ä¿®å¤ï¼šä»zeGoTokenå¤åˆ¶åˆ°zeGoTokenThird');
				}
			}

			console.log('ğŸ¬ [remoteVideo] æœ€ç»ˆå­˜å‚¨æ•°æ®æ£€æŸ¥:', {
				roomId: roomId ? 'å·²è·å–' : 'æœªè·å–',
				sid: sid ? 'å·²è·å–' : 'æœªè·å–',
				zeGoTokenThird: zeGoTokenThird ? 'å·²è·å–' : 'æœªè·å–',
				tokenSource: zeGoTokenThird ? (uni.getStorageSync('zeGoTokenThird') === zeGoTokenThird ? 'zeGoTokenThird' : 'zeGoToken(ä¿®å¤)') : 'æ— '
			});

			if (!roomId || !sid || !zeGoTokenThird) {
				let missingItems = [];
				if (!roomId) missingItems.push('roomID');
				if (!sid) missingItems.push('remoteUserId');
				if (!zeGoTokenThird) missingItems.push('zeGoTokenThird');
				
				console.error('ğŸ¬ [remoteVideo] ç¼ºå°‘å¿…è¦çš„å­˜å‚¨æ•°æ®:', missingItems);
				uni.showToast({
					title: `è¿œç¨‹è§†é¢‘åˆå§‹åŒ–æ•°æ®ä¸å®Œæ•´ï¼Œç¼ºå°‘ï¼š${missingItems.join('ã€')}`,
					icon: 'none',
					duration: 3000
				});
				return;
			}

			keyCenter.setToken(zeGoTokenThird);
			console.log('ğŸ¬ [remoteVideo] Tokenè®¾ç½®å®Œæˆ');

			// å¦‚æœå¼•æ“è¿˜æœªåˆ›å»ºï¼Œåˆ™åˆ›å»ºå¼•æ“
			if (!engine.value) {
				console.log('ğŸ¬ [remoteVideo] å¼€å§‹åˆ›å»ºZegoå¼•æ“...');
				await createEngine()
				console.log('ğŸ¬ [remoteVideo] Zegoå¼•æ“åˆ›å»ºå®Œæˆ');
			} else {
				console.log('ğŸ¬ [remoteVideo] Zegoå¼•æ“å·²å­˜åœ¨ï¼Œè·³è¿‡åˆ›å»º');
			}

			console.log('ğŸ¬ [remoteVideo] å¼€å§‹ç™»å½•æˆ¿é—´...', {
				roomId,
				userID: userInfo.playerOnly + "-third",
				userName: userInfo.playerName + "-third"
			});

			// ç½‘ç»œç¯å¢ƒæ£€æŸ¥å’Œé‡è¯•æœºåˆ¶
			let loginSuccess = false;
			for (let attempt = 1; attempt <= 3; attempt++) {
				try {
					console.log(`ğŸ¬ [remoteVideo] ç™»å½•å°è¯• ${attempt}/3`);
					await Promise.race([
						loginRoom(roomId, userInfo.playerOnly + "-third", userInfo.playerName + "-third"),
						new Promise((_, reject) => setTimeout(() => reject(new Error('ç™»å½•è¶…æ—¶')), 10000))
					]);
					loginSuccess = true;
					console.log('ğŸ¬ [remoteVideo] æˆ¿é—´ç™»å½•å®Œæˆ');
					break;
				} catch (loginError) {
					console.log(`ğŸ¬ [remoteVideo] ç™»å½•å°è¯• ${attempt} å¤±è´¥:`, loginError.message);
					if (attempt < 3) {
						console.log(`ğŸ¬ [remoteVideo] ç­‰å¾… ${attempt * 2}s åé‡è¯•...`);
						await new Promise(resolve => setTimeout(resolve, attempt * 2000));
					}
				}
			}

			if (!loginSuccess) {
				throw new Error('æˆ¿é—´ç™»å½•å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
			}

			// ğŸµ é…ç½®å›éŸ³æ¶ˆé™¤ - è§£å†³é‡éŸ³é—®é¢˜ï¼ˆè¿œç¨‹ç«¯ï¼‰
			try {
				// è¿œç¨‹ç«¯ä¸»è¦é…ç½®æ’­æ”¾ç›¸å…³çš„éŸ³é¢‘å¤„ç†
				// æ³¨æ„ï¼šAECã€AGCã€ANSä¸»è¦åœ¨å‘é€ç«¯(localVideo)é…ç½®
				// è¿™é‡Œä¸»è¦ç¡®ä¿éŸ³é¢‘è·¯ç”±æ­£ç¡®
				await engine.value.setAudioRouteToSpeaker(true);
			} catch (audioError) {
				console.error('âŒ [å›éŸ³æ¶ˆé™¤-è¿œç¨‹] éŸ³é¢‘é…ç½®å¤±è´¥:', audioError);
				// ä¸é˜»æ–­æµç¨‹ï¼Œç»§ç»­æ‰§è¡Œ
			}

			// æ·»åŠ æ’­æ”¾ç›‘å¬å™¨
			addPlayListeners();
			console.log('ğŸ¬ [remoteVideo] æ’­æ”¾ç›‘å¬å™¨å·²æ·»åŠ ');

			// è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
			setupEventListeners();

			// iOSè®¾å¤‡ç‰¹å®šå¤„ç†
			await handleIOSVideoIssue();

			// å¼€å§‹æ’­æ”¾è¿œç¨‹æµï¼Œå¢åŠ é‡è¯•æœºåˆ¶
			console.log('ğŸ¬ [remoteVideo] å¼€å§‹æ’­æ”¾è¿œç¨‹æµ...', { streamID: sid });
			let playSuccess = false;
			for (let attempt = 1; attempt <= 3; attempt++) {
				try {
					console.log(`ğŸ¬ [remoteVideo] æ’­æ”¾å°è¯• ${attempt}/3`);
					await startPlayingStream(sid);
					isPlayingActive.value = true;
					playSuccess = true;
					console.log('ğŸ¬ [remoteVideo] âœ… è¿œç¨‹æµæ’­æ”¾æˆåŠŸ');
					break;
				} catch (playError) {
					console.log(`ğŸ¬ [remoteVideo] æ’­æ”¾å°è¯• ${attempt} å¤±è´¥:`, playError.message);
					if (attempt < 3) {
						console.log(`ğŸ¬ [remoteVideo] ç­‰å¾… ${attempt}s åé‡è¯•...`);
						await new Promise(resolve => setTimeout(resolve, attempt * 1000));
					}
				}
			}

			if (!playSuccess) {
				console.error('ğŸ¬ [remoteVideo] âŒ è¿œç¨‹æµæ’­æ”¾å¤±è´¥ï¼Œå¯èƒ½å¯¹æ–¹è¿˜æœªå¼€å§‹æ¨æµ');
				uni.showToast({
					title: 'è¿œç¨‹è§†é¢‘è¿æ¥å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•',
					icon: 'none',
					duration: 3000
				});
			}

			console.log('ğŸ¬ [remoteVideo] ===== è¿œç¨‹è§†é¢‘åˆå§‹åŒ–å®Œæˆ =====');

		} catch (error) {
			console.error('ğŸ¬ [remoteVideo] init å¤±è´¥:', error);
			console.error('ğŸ¬ [remoteVideo] é”™è¯¯è¯¦æƒ…:', {
				message: error.message,
				stack: error.stack,
				name: error.name
			});
			uni.showToast({
				title: 'è¿œç¨‹è§†é¢‘åˆå§‹åŒ–å¤±è´¥: ' + error.message,
				icon: 'none',
				duration: 3000
			});
		} finally {
			initializationInProgress.value = false;
		}
	}

	// iOSè®¾å¤‡ç‰¹å®šå¤„ç†
	const handleIOSVideoIssue = async () => {
		const systemInfo = uni.getSystemInfoSync();

		// é’ˆå¯¹ç‰¹å®šiOSç‰ˆæœ¬æˆ–è®¾å¤‡å‹å·çš„å¤„ç†
		if (systemInfo.platform === 'ios') {
			// æ ¹æ®iOSç‰ˆæœ¬è°ƒæ•´å»¶è¿Ÿæ—¶é—´
			const iosVersion = parseFloat(systemInfo.system.replace('iOS ', ''));
			const delayTime = iosVersion < 14 ? 2000 : 1000; // è€ç‰ˆæœ¬iOSéœ€è¦æ›´é•¿å»¶è¿Ÿ

			await new Promise(resolve => setTimeout(resolve, delayTime));

			// æ£€æŸ¥æ’­æ”¾çŠ¶æ€ï¼Œå¦‚æœéœ€è¦åˆ™é‡æ–°å¯åŠ¨
			if (engine.value && isPlayingActive.value) {
				try {
					// å…ˆåœæ­¢å†å¯åŠ¨æ’­æ”¾ï¼Œç¡®ä¿æµæ­£ç¡®ç»‘å®šåˆ°è§†å›¾
					await stopPlayingStream(sid);
					await new Promise(resolve => setTimeout(resolve, 500)); // çŸ­æš‚å»¶è¿Ÿ
					await startPlayingStream(sid);
				} catch (error) {
					// å¤‡ç”¨æ–¹æ¡ˆï¼šå¤šæ¬¡é‡è¯•
					for (let i = 0; i < 3; i++) {
						try {
							await new Promise(resolve => setTimeout(resolve, 500));
							await startPlayingStream(sid);
							break;
						} catch (retryError) {
							// ç»§ç»­é‡è¯•
						}
					}
				}
			}
		}
	};

	// æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
	const setupEventListeners = () => {
		uni.$on('stopRemoteVideo', async (e) => {
			try {
				// ğŸ”§ åœæ­¢è¿œç¨‹è§†é¢‘æ—¶çš„å®Œæ•´æ¸…ç†
				await stopPlayingStream(sid);
				isPlayingActive.value = false;

				// é€€å‡ºæˆ¿é—´
				const roomId = uni.getStorageSync('roomID');
				if (engine.value && roomId) {
					await logoutRoom(roomId);
				}
			} catch (error) {
				console.error('åœæ­¢è¿œç¨‹è§†é¢‘æ—¶å‡ºé”™:', error);
			}
		});

		uni.$on('resize', async (e) => {
			if (engine.value) {
				engine.value.setAppOrientation(e);
			}
		});

		// ç›‘å¬è¿œç¨‹æµçŠ¶æ€å˜åŒ–
		uni.$on('remoteStreamStateChanged', (data) => {
			if (data.streamID === sid) {
				if (data.state === 'PLAYING') {
					isPlayingActive.value = true;
				} else if (data.state === 'NO_PLAY') {
					isPlayingActive.value = false;
				}
			}
		});

		// ç›‘å¬æˆæƒå®Œæˆäº‹ä»¶ï¼Œé‡æ–°å°è¯•åˆå§‹åŒ–
		uni.$on('auth-completed-restart-video', () => {
			console.log('ğŸ¬ [remoteVideo] æ”¶åˆ°æˆæƒå®Œæˆäº‹ä»¶ï¼Œæ£€æŸ¥æ˜¯å¦éœ€è¦é‡æ–°åˆå§‹åŒ–');
			if (!isPlayingActive.value && isPageActive.value) {
				console.log('ğŸ¬ [remoteVideo] æˆæƒå®Œæˆåé‡æ–°åˆå§‹åŒ–è¿œç¨‹è§†é¢‘');
				setTimeout(() => {
					init();
				}, 500);
			}
		});
	};

	// åˆå§‹åŒ–æ—¶æ˜¾ç¤ºäº¤äº’å…ƒç´ 
	onMounted(() => {
		showInteractionElements();
		isPageActive.value = true;
	});

	// é¡µé¢ç”Ÿå‘½å‘¨æœŸç®¡ç†
	onUnmounted(() => {
		isPageActive.value = false;
		isPlayingActive.value = false;
		initializationInProgress.value = false;
	});

	onUnload(async () => {
		try {
			// ğŸ”§ æ··åˆæ¨¡å¼å…¼å®¹ï¼šé¡µé¢å¸è½½æ—¶åªé”€æ¯å¼•æ“ï¼Œä¸æ–­å¼€è¿æ¥
			// å› ä¸ºæ··åˆæ¨¡å¼çš„"ä¸‹ä¸€å±€"ä¼šé‡æ–°å¯åŠ¨é¡µé¢ï¼Œä½†ä¸åº”è¯¥æ–­å¼€è¯­éŸ³è¿æ¥
			// çœŸæ­£çš„æ–­å¼€è¿æ¥é€šè¿‡ stopRemoteVideo äº‹ä»¶å¤„ç†

			isPageActive.value = false;
			initializationInProgress.value = false;
			isPlayingActive.value = false;

			ZegoExpressEngine.destroyEngine();

		} catch (error) {
			// ç¡®ä¿å³ä½¿å‡ºé”™ä¹Ÿè¦é”€æ¯å¼•æ“
			isPlayingActive.value = false;
			ZegoExpressEngine.destroyEngine();
		}
	})

	// ğŸµ ç®€åŒ–çš„éŸ³é¢‘æ§åˆ¶å‡½æ•° - å›åˆ°åŸæœ‰æ–¹æ¡ˆ
	const voice = () => {
		voiceDisable.value = !voiceDisable.value;
		if (engine.value && sid) {
			engine.value.mutePlayStreamAudio(sid, voiceDisable.value);
		}
		console.log(`ğŸ”Š [remoteVideo] è¿œç¨‹éŸ³é¢‘å·²${voiceDisable.value ? 'å…³é—­' : 'å¼€å¯'}`);
	}

	// æ‹–æ‹½äº‹ä»¶å¤„ç†
	const handleTouchStart = (event) => {
		showInteractionElements() // æ˜¾ç¤ºäº¤äº’å…ƒç´ 

		// æ£€æŸ¥æ˜¯å¦ç‚¹å‡»åœ¨ç‰¹æ®Šå…ƒç´ ä¸Šï¼ˆåŒ…æ‹¬å­å…ƒç´ ï¼‰
		const target = event.target || event.currentTarget
		let currentElement = target

		// å‘ä¸Šéå†DOMæ ‘ï¼Œæ£€æŸ¥æ˜¯å¦åœ¨ç‰¹æ®Šæ§åˆ¶ç‚¹å†…
		while (currentElement && currentElement !== event.currentTarget) {
			if (currentElement.classList && (
				currentElement.classList.contains('scale-corner') ||
				currentElement.classList.contains('voice') // ğŸµ æ·»åŠ éŸ³é¢‘æŒ‰é’®æ£€æŸ¥
			)) {
				console.log('ç‚¹å‡»åœ¨ç‰¹æ®Šæ§åˆ¶å…ƒç´ ä¸Šï¼Œä¸å¤„ç†æ‹–æ‹½')
				return // å¦‚æœç‚¹å‡»åœ¨ç‰¹æ®Šæ§åˆ¶å…ƒç´ ä¸Šï¼Œä¸å¤„ç†æ‹–æ‹½
			}
			currentElement = currentElement.parentElement
		}

		// å¦‚æœæ­£åœ¨è¿›è¡Œè§’è½ç¼©æ”¾ï¼Œä¸å¤„ç†æ‹–æ‹½
		if (cornerScaleData.value) {
			console.log('æ­£åœ¨è¿›è¡Œè§’è½ç¼©æ”¾ï¼Œä¸å¤„ç†æ‹–æ‹½')
			return
		}

		// ç§»é™¤åŒæŒ‡ç¼©æ”¾åŠŸèƒ½ï¼Œç®€åŒ–æ“ä½œä½“éªŒ
		// åŒæŒ‡ç¼©æ”¾å·²ç¦ç”¨ï¼Œä¸“æ³¨äºå››è§’æ‹–æ‹½ç¼©æ”¾

		if (!dragMode.value) return

		console.log('è¿œç¨‹è§†é¢‘å¼€å§‹æ‹–æ‹½', event);
		// nvueä¸­ä½¿ç”¨changedTouchesè€Œä¸æ˜¯touches
		let touch = null;
		if (event.changedTouches && event.changedTouches.length > 0) {
			touch = event.changedTouches[0];
		} else if (event.touches && event.touches.length > 0) {
			touch = event.touches[0];
		}

		if (!touch) {
			console.error('æ— æ³•è·å–è§¦æ‘¸ç‚¹ä¿¡æ¯', event);
			return;
		}

		dragData.value = {
			startX: touch.screenX || touch.pageX || touch.clientX || 0,
			startY: touch.screenY || touch.pageY || touch.clientY || 0,
			startTime: Date.now(),
			lastX: touch.screenX || touch.pageX || touch.clientX || 0,
			lastY: touch.screenY || touch.pageY || touch.clientY || 0
		}
		console.log('è¿œç¨‹è§†é¢‘æ‹–æ‹½æ•°æ®åˆå§‹åŒ–:', dragData.value);
	}

	const handleTouchMove = (event) => {
		// ç§»é™¤åŒæŒ‡ç¼©æ”¾åŠŸèƒ½ï¼Œç®€åŒ–æ“ä½œä½“éªŒ
		// åŒæŒ‡ç¼©æ”¾å·²ç¦ç”¨ï¼Œä¸“æ³¨äºå››è§’æ‹–æ‹½ç¼©æ”¾

		if (!dragMode.value || !dragData.value) return

		event.preventDefault()
		// nvueä¸­ä½¿ç”¨changedTouchesè€Œä¸æ˜¯touches
		let touch = null;
		if (event.changedTouches && event.changedTouches.length > 0) {
			touch = event.changedTouches[0];
		} else if (event.touches && event.touches.length > 0) {
			touch = event.touches[0];
		}

		if (!touch) {
			console.error('handleTouchMove: æ— æ³•è·å–è§¦æ‘¸ç‚¹ä¿¡æ¯');
			return;
		}

		const currentX = touch.screenX || touch.pageX || touch.clientX || 0
		const currentY = touch.screenY || touch.pageY || touch.clientY || 0

		// è®¡ç®—ç›¸å¯¹äºä¸Šä¸€æ¬¡ä½ç½®çš„å¢é‡
		const deltaX = currentX - dragData.value.lastX
		const deltaY = currentY - dragData.value.lastY

		// æ›´æ–°æœ€åä½ç½®
		dragData.value.lastX = currentX
		dragData.value.lastY = currentY

		console.log('è¿œç¨‹è§†é¢‘æ‹–æ‹½ç§»åŠ¨', { deltaX, deltaY, currentX, currentY });

		// é€šçŸ¥çˆ¶é¡µé¢æ›´æ–°ä½ç½®
		uni.$emit('remoteVideoMove', { deltaX, deltaY })
	}

	const handleTouchEnd = (event) => {
		// ç§»é™¤åŒæŒ‡ç¼©æ”¾åŠŸèƒ½ï¼Œç®€åŒ–æ“ä½œä½“éªŒ
		// åŒæŒ‡ç¼©æ”¾å·²ç¦ç”¨ï¼Œä¸“æ³¨äºå››è§’æ‹–æ‹½ç¼©æ”¾

		if (!dragMode.value) return
		console.log('è¿œç¨‹è§†é¢‘ç»“æŸæ‹–æ‹½');
		dragData.value = null
	}

	// ç›‘å¬æ‹–æ‹½æ¨¡å¼åˆ‡æ¢
	uni.$on('remoteDragModeChange', (enabled) => {
		dragMode.value = enabled
	})

	// ç›‘å¬å…³é—­æŒ‰é’®çŠ¶æ€å˜åŒ–å’Œçª—å£ä½ç½®æ›´æ–°
	uni.$on('remoteVideoSizeChange', (data) => {
		// åªæœ‰åœ¨æ˜ç¡®ä¼ é€’isOverSizeä¸”ä¸ä¸ºfalseæ—¶æ‰æ›´æ–°å…³é—­æŒ‰é’®çŠ¶æ€
		if (data.hasOwnProperty('isOverSize') && data.isOverSize !== false) {
			isOverDefaultSize.value = data.isOverSize
		}
		// å§‹ç»ˆæ›´æ–°çª—å£ä½ç½®ä¿¡æ¯
		if (data.windowPosition) {
			windowPosition.value = data.windowPosition
		}
	})

	// ç›‘å¬ç¼©æ”¾æ¨¡å¼åˆ‡æ¢
	uni.$on('remoteScaleModeChange', (enabled) => {
		scaleMode.value = enabled
		console.log('è¿œç¨‹è§†é¢‘ç¼©æ”¾æ¨¡å¼åˆ‡æ¢:', enabled)
	})

	// è®¡ç®—ä¸¤ç‚¹é—´è·ç¦»
	const getDistance = (touch1, touch2) => {
		const dx = touch1.screenX - touch2.screenX
		const dy = touch1.screenY - touch2.screenY
		return Math.sqrt(dx * dx + dy * dy)
	}

	// å¤„ç†ç¼©æ”¾æ‰‹åŠ¿ï¼ˆåŒæŒ‡ï¼‰
	const handleScaleGesture = (event) => {
		if (!scaleMode.value) return false

		if (event.changedTouches && event.changedTouches.length >= 2) {
			const touch1 = event.changedTouches[0]
			const touch2 = event.changedTouches[1]
			const distance = getDistance(touch1, touch2)

			if (event.type === 'touchstart') {
				initialDistance.value = distance
				scaleData.value = {
					startDistance: distance,
					startScale: 1.0
				}
				console.log('è¿œç¨‹è§†é¢‘å¼€å§‹ç¼©æ”¾æ‰‹åŠ¿', { distance })
				return true
			} else if (event.type === 'touchmove' && scaleData.value) {
				const scale = distance / scaleData.value.startDistance
				const clampedScale = Math.max(0.5, Math.min(3.0, scale))

				console.log('è¿œç¨‹è§†é¢‘ç¼©æ”¾æ‰‹åŠ¿ç§»åŠ¨', { distance, scale: clampedScale })

				// é€šçŸ¥çˆ¶é¡µé¢æ›´æ–°ç¼©æ”¾
				uni.$emit('remoteVideoScale', { scale: clampedScale })
				return true
			} else if (event.type === 'touchend') {
				scaleData.value = null
				console.log('è¿œç¨‹è§†é¢‘ç»“æŸç¼©æ”¾æ‰‹åŠ¿')
				return true
			}
		}
		return false
	}

	// è§’è½ç¼©æ”¾æ§åˆ¶ç‚¹å¤„ç†
	const handleScaleStart = (event) => {
		if (!scaleMode.value) return

		event.stopPropagation() // é˜»æ­¢äº‹ä»¶å†’æ³¡
		event.preventDefault() // é˜»æ­¢é»˜è®¤è¡Œä¸º

		showInteractionElements() // æ˜¾ç¤ºäº¤äº’å…ƒç´ 

		const touch = event.changedTouches?.[0] || event.touches?.[0]
		if (!touch) return

		// ğŸ”§ ä¿®å¤è§’è½æ£€æµ‹ï¼šåŸºäºçª—å£è‡ªèº«ä½ç½®è€Œä¸æ˜¯å±å¹•ä¸­å¿ƒ
		const touchX = touch.screenX || touch.pageX || touch.clientX || 0
		const touchY = touch.screenY || touch.pageY || touch.clientY || 0

		// è·å–çª—å£çš„å®é™…ä½ç½®å’Œå°ºå¯¸
		const windowLeft = windowPosition.value.left
		const windowTop = windowPosition.value.top
		const windowWidth = windowPosition.value.width
		const windowHeight = windowPosition.value.height

		// è®¡ç®—çª—å£çš„ä¸­å¿ƒç‚¹
		const windowCenterX = windowLeft + windowWidth / 2
		const windowCenterY = windowTop + windowHeight / 2

		// åŸºäºçª—å£ä¸­å¿ƒåˆ¤æ–­è§’è½ï¼ˆè€Œä¸æ˜¯å±å¹•ä¸­å¿ƒï¼‰
		let corner = 'tl'
		const isLeft = touchX < windowCenterX
		const isTop = touchY < windowCenterY

		if (isLeft && isTop) corner = 'tl'      // å·¦ä¸Šè§’
		else if (!isLeft && isTop) corner = 'tr'  // å³ä¸Šè§’
		else if (isLeft && !isTop) corner = 'bl'  // å·¦ä¸‹è§’
		else corner = 'br'                        // å³ä¸‹è§’





		cornerScaleData.value = {
			startX: touchX,
			startY: touchY,
			corner: corner,
			lastUpdateTime: Date.now(), // ä¸Šæ¬¡æ›´æ–°æ—¶é—´
			updateCount: 0 // æ›´æ–°è®¡æ•°å™¨
		}


	}

	const handleScaleMove = (event) => {
		if (!scaleMode.value || !cornerScaleData.value) return

		event.stopPropagation()
		event.preventDefault()

		const touch = event.changedTouches?.[0] || event.touches?.[0]
		if (!touch) return

		const currentX = touch.screenX || touch.pageX || touch.clientX || 0
		const currentY = touch.screenY || touch.pageY || touch.clientY || 0

		// è®¡ç®—ä»èµ·å§‹ç‚¹çš„è·ç¦»
		const deltaX = currentX - cornerScaleData.value.startX
		const deltaY = currentY - cornerScaleData.value.startY

		// æç®€ç®—æ³•ï¼šå¼ºåŠ›èŠ‚æµ + ç®€å•è®¡ç®—
		const corner = cornerScaleData.value.corner
		const currentTime = Date.now()

		// å¼ºåŠ›èŠ‚æµï¼šæ¯100msæ‰æ›´æ–°ä¸€æ¬¡ï¼Œå¤§å¹…å‡å°‘é—ªåŠ¨
		const timeDiff = currentTime - cornerScaleData.value.lastUpdateTime
		if (timeDiff < 100) {
			return
		}

		// æ¯3æ¬¡ç§»åŠ¨æ‰å¤„ç†ä¸€æ¬¡ï¼Œè¿›ä¸€æ­¥å‡å°‘é¢‘ç‡
		cornerScaleData.value.updateCount++
		if (cornerScaleData.value.updateCount % 3 !== 0) {
			return
		}

		// ä½¿ç”¨å·²ç»å®šä¹‰çš„deltaXå’ŒdeltaYå˜é‡
		// åŸºäºçª—å£å®é™…ä½ç½®çš„æ™ºèƒ½ç¼©æ”¾è®¡ç®—
		let widthChange = 0
		let heightChange = 0

		const sensitivity = 0.8 // æé«˜çµæ•åº¦ï¼Œæ”¹å–„ç”¨æˆ·ä½“éªŒ

		// ğŸ”§ çœŸæ­£åŸºäºçª—å£ä¸­å¿ƒç‚¹çš„æ™ºèƒ½ç¼©æ”¾é€»è¾‘ï¼š
		// è®¡ç®—çª—å£ä¸­å¿ƒç‚¹ä½ç½®
		const windowCenterX = windowPosition.value.left + windowPosition.value.width / 2;
		const windowCenterY = windowPosition.value.top + windowPosition.value.height / 2;

		// è®¡ç®—å„ä¸ªè§’ç›¸å¯¹äºçª—å£ä¸­å¿ƒçš„æœŸæœ›æ–¹å‘
		let expectedDirectionX = 0; // æœŸæœ›çš„Xæ–¹å‘ï¼š-1å‘å·¦ï¼Œ1å‘å³
		let expectedDirectionY = 0; // æœŸæœ›çš„Yæ–¹å‘ï¼š-1å‘ä¸Šï¼Œ1å‘ä¸‹

		if (corner === 'tl') {
			expectedDirectionX = -1; // å·¦ä¸Šè§’åº”è¯¥å‘å·¦
			expectedDirectionY = -1; // å·¦ä¸Šè§’åº”è¯¥å‘ä¸Š
		} else if (corner === 'tr') {
			expectedDirectionX = 1;  // å³ä¸Šè§’åº”è¯¥å‘å³
			expectedDirectionY = -1; // å³ä¸Šè§’åº”è¯¥å‘ä¸Š
		} else if (corner === 'bl') {
			expectedDirectionX = -1; // å·¦ä¸‹è§’åº”è¯¥å‘å·¦
			expectedDirectionY = 1;  // å·¦ä¸‹è§’åº”è¯¥å‘ä¸‹
		} else if (corner === 'br') {
			expectedDirectionX = 1;  // å³ä¸‹è§’åº”è¯¥å‘å³
			expectedDirectionY = 1;  // å³ä¸‹è§’åº”è¯¥å‘ä¸‹
		}

		// åˆ¤æ–­å®é™…æ‹–æ‹½æ–¹å‘æ˜¯å¦ä¸æœŸæœ›æ–¹å‘ä¸€è‡´
		const actualDirectionX = deltaX > 0 ? 1 : (deltaX < 0 ? -1 : 0);
		const actualDirectionY = deltaY > 0 ? 1 : (deltaY < 0 ? -1 : 0);

		// è®¡ç®—æ–¹å‘ä¸€è‡´æ€§ï¼šä¸€è‡´ä¸ºæ­£ï¼ˆæ”¾å¤§ï¼‰ï¼Œä¸ä¸€è‡´ä¸ºè´Ÿï¼ˆç¼©å°ï¼‰
		const directionConsistencyX = expectedDirectionX * actualDirectionX;
		const directionConsistencyY = expectedDirectionY * actualDirectionY;

		// åŸºäºæ–¹å‘ä¸€è‡´æ€§è®¡ç®—ç¼©æ”¾å˜åŒ–
		widthChange = Math.abs(deltaX) * sensitivity * Math.sign(directionConsistencyX);
		heightChange = Math.abs(deltaY) * sensitivity * Math.sign(directionConsistencyY);



		// æœ€å°å˜åŒ–é˜ˆå€¼
		const minChange = 15
		if (Math.abs(widthChange) < minChange && Math.abs(heightChange) < minChange) {
			return
		}

		cornerScaleData.value.lastUpdateTime = currentTime



		// é€šçŸ¥çˆ¶é¡µé¢æ›´æ–°å°ºå¯¸ï¼ˆéç­‰æ¯”ï¼‰
		uni.$emit('remoteVideoResize', {
			widthChange,
			heightChange,
			corner
		})
	}

	const handleScaleEnd = (event) => {
		if (!scaleMode.value) return

		event.stopPropagation()
		console.log('è¿œç¨‹è§†é¢‘ç»“æŸè§’è½ç¼©æ”¾')
		cornerScaleData.value = null
	}

	// äº¤äº’æ˜¾ç¤ºç®¡ç†
	const showInteractionElements = () => {
		showInteraction.value = true

		// æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
		if (interactionTimer.value) {
			clearTimeout(interactionTimer.value)
		}

		// 8ç§’åéšè—äº¤äº’å…ƒç´ 
		interactionTimer.value = setTimeout(() => {
			showInteraction.value = false
		}, 8000)
	}

	// é‡ç½®åˆ°é»˜è®¤å¤§å°å’Œä½ç½®
	const resetToDefault = () => {
		uni.$emit('remoteVideoReset')
		isOverDefaultSize.value = false
		showInteractionElements()
	}

	// æ£€æŸ¥æ˜¯å¦è¶…è¿‡é»˜è®¤å¤§å°
	const checkOverDefaultSize = (scale) => {
		const wasOverSize = isOverDefaultSize.value
		isOverDefaultSize.value = scale > 1.05 // è¶…è¿‡é»˜è®¤å¤§å°5%æ—¶å°±æ˜¾ç¤ºå…³é—­æŒ‰é’®
	}

	// åˆå§‹åŒ–æ—¶æ˜¾ç¤ºäº¤äº’å…ƒç´ 
	onMounted(() => {
		showInteractionElements()
	})
</script>
<style>
	.video-container {
		display: flex;
		flex-direction: column;
		flex: 1;
	}

	.voice {
		position: absolute;
		top: 0;
		right: 26rpx;
		width: 16rpx; /* è§†è§‰å¤§å°ä¿æŒå°å·§ */
		height: 30rpx;
		z-index: 100; /* ç¡®ä¿åœ¨æœ€ä¸Šå±‚ */
		/* æ‰©å¤§ç‚¹å‡»åŒºåŸŸçš„æŠ€å·§ */
		display: flex;
		justify-content: center;
		align-items: center;
	}
	/* å…³é—­æŒ‰é’®æ ·å¼ */
	.close-button {
		position: absolute;
		top: 5px;
		left: 50%;
		transform: translateX(-50%);
		background-color: rgba(0, 0, 0, 0.8);
		border-radius: 15px;
		padding: 5px 15px;
		z-index: 20;
	}

	.close-text {
		color: #ffffff;
		font-size: 12px;
	}



	/* ä¸­å¿ƒæ‹–æ‹½åå­—ç®­å¤´ - å®‰å“å…¼å®¹ç‰ˆæœ¬ */
	.drag-center {
		position: absolute;
		top: 0px;
		left: 0px;
		right: 0px;
		bottom: 0px;
		z-index: 15;
		display: flex;
		justify-content: center;
		align-items: center;
	}

	.drag-line {
		position: absolute;
		background-color: #00BFFF;
		opacity: 0.8;
	}

	.drag-line-h {
		top: 18px;
		left: 4px;
		width: 32px;
		height: 4px;
	}

	.drag-line-v {
		left: 18px;
		top: 4px;
		width: 4px;
		height: 32px;
	}

	/* åå­—ç®­å¤´å®¹å™¨ */
	.drag-cross-container {
		position: relative;
		width: 36px;
		height: 36px;
	}

	/* å››è§’ç¼©æ”¾æ§åˆ¶ç‚¹æ ·å¼ - ç›´æ¥å®šä½ç‰ˆæœ¬ */

	.scale-corner {
		position: absolute;
		width: 48px;
		height: 48px;
		z-index: 15;
	}

	.scale-corner-tl {
		top: -20px;  /* è°ƒæ•´ä¸º40x40pxçš„ä¸­å¿ƒå¯¹é½ */
		left: -20px;
	}

	.scale-corner-tr {
		top: -25px;
		right: -25px;
	}

	.scale-corner-bl {
		bottom: -20px;
		left: -20px;
	}

	.scale-corner-br {
		bottom: -20px;
		right: -20px;
	}

	.corner-lines {
		position: relative;
		width: 100%;
		height: 100%;
	}

	.corner-line {
		position: absolute;
		opacity: 1.0;
		border-radius: 3px;
		box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
	}

	.corner-line-h {
		width: 28px;
		height: 5px;
	}

	.corner-line-v {
		width: 5px;
		height: 28px;
	}

	/* å·¦ä¸Šè§’çº¿æ¡ä½ç½® - åœ¨40x40å®¹å™¨ä¸­å±…ä¸­ */
	.scale-corner-tl .corner-line-h {
		top: 18px;   /* 40pxå®¹å™¨çš„ä¸­å¿ƒä½ç½® */
		left: 10px;
	}

	.scale-corner-tl .corner-line-v {
		top: 10px;
		left: 18px;
	}

	/* å³ä¸Šè§’çº¿æ¡ä½ç½® - åœ¨40x40å®¹å™¨ä¸­å±…ä¸­ */
	.scale-corner-tr .corner-line-h {
		top: 18px;
		right: 10px;
	}

	.scale-corner-tr .corner-line-v {
		top: 10px;
		right: 18px;
	}

	/* å·¦ä¸‹è§’çº¿æ¡ä½ç½® - åœ¨40x40å®¹å™¨ä¸­å±…ä¸­ */
	.scale-corner-bl .corner-line-h {
		bottom: 18px;
		left: 10px;
	}

	.scale-corner-bl .corner-line-v {
		bottom: 10px;
		left: 18px;
	}

	/* å³ä¸‹è§’çº¿æ¡ä½ç½® - åœ¨40x40å®¹å™¨ä¸­å±…ä¸­ */
	.scale-corner-br .corner-line-h {
		bottom: 18px;
		right: 10px;
	}

	.scale-corner-br .corner-line-v {
		bottom: 10px;
		right: 18px;
	}

	/* é€æ˜çŠ¶æ€ */
	.transparent {
		opacity: 0.1;
	}
</style>